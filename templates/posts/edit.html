<div class="row">
    <div class="col">
        <%= if (errors) { %>
            <%= for (key, val) in errors { %>
                <div class="alert alert-danger alert-dismissible fade show m-1" role="alert">
                    <%= val %>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            <% } %>
        <% } %>
    </div>
</div>
<div class="row mt-3 justify-content-center">
    <div class="col-md-8 col-sm-10">
        <h2>Edit this post</h2>
        <form action="<%= editPostsPath({pid: post.ID}) %>" method="POST">
            <%= csrf() %>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" name="Title" class="form-control" id="title" value="<%= post.Title %>">
            </div>
            <div class="form-group">
                <label for="title">分类</label>
                <select class="form-control" id="category" name="CategoryID">
                    <option value="0">请选择分类</option>
                    <%= for (c) in _categories { %>
                        <%= if (c.ID.String() == post.CategoryID.String()) { %>
                        <option value="<%= c.ID %>" selected><%= c.Name %></option>
                        <% } else { %>
                        <option value="<%= c.ID %>" ><%= c.Name %></option>
                        <% } %>
                    <% } %>
                </select>
            </div>
            <div class="form-group" style="z-index: 9; position: relative;">
                <label for="content">Content</label>
                <div id="editSection"></div>
            </div>
            <textarea style="display:none;" name="Content" id="content"><%= post.Content %></textarea>
            <input type="hidden" name="TopImageID" id="attachment" value="0393a648-5a61-4954-8fe6-a13e8de97b23"/>
            <button type="submit" class="btn btn-primary">Update</button>
        </form>
    </div>
</div>
<link rel="stylesheet" href="https://uicdn.toast.com/tui-editor/latest/tui-editor.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui-editor/latest/tui-editor-contents.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.css" />
<script src="https://uicdn.toast.com/tui-editor/latest/tui-editor-Editor-full.js"></script>
<script>
    var url = '<%= attachmentsPath() %>'

    $('#up').change(function() {
        var formData = new FormData();
        formData.append('file', $('#up')[0].files[0]);
        $.ajax({
            type: "POST",
            url: url,
            data: formData,
            contentType: false,
            processData: false,
            dataType:'json',
        }).then(function(res) {
            console.log(res)
            $('#preview-image').html('<img src="' + res.url + '" />');
            $('#attachment').val(res.id);
        })
    })
    const editor = new tui.Editor({
        el: document.querySelector('#editSection'),
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        height: '300px',
        initialValue: document.querySelector('#content').value,
        hooks: {
            addImageBlobHook: (fileOrBlob, callback, source) => {
                uploadImage(fileOrBlob).then(res => {
                    const customDescription = `${res.url}_foo`;
                    console.log(res);
                    callback(res.url, customDescription);
                });
            }
        }
    });

    $('#form').on('submit', (e) => {
        var content = editor.getMarkdown();
        $('#content').val(content);
        var canSubmit = false;
        if ($('#form input[name="Title"]').val() === '') {
            swal({
                title: "请填写标题",
                icon: "error"
            });
        } else if($('#content').val() === '') {
            swal({
                title: "请输入正文",
                icon: "error"
            });
        } else if($('#category').val() == 0) {
            swal({
                title: "请选择分类",
                icon: "error"
            });
        } else {
            canSubmit = true;
        }
        canSubmit ? '' : e.preventDefault();
    })
    function uploadImage(fileOrBlob) {
        const result = {}

        if (Object.prototype.toString.call(fileOrBlob) === '[object File]') {
            const formData = new FormData();
            formData.append('file', fileOrBlob);
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: "POST",
                    url: url,
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                }).then(res => {
                    resolve(res);
                }).catch(err => {
                    reject(error)
                })
            });
        }
        return false;
    }
</script>
